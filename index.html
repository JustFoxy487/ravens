<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ravens Sheet</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --panel2:#101a2b;
      --text:#e9eefc;
      --muted:#9fb0d0;
      --line:rgba(255,255,255,.08);
      --accent:#7aa2ff;
      --ok:#4fe3a3;
      --danger:#ff6b7a;
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --r:18px;
      --r2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(1000px 650px at 75% 20%, rgba(79,227,163,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }

    .app{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:16px;
      padding:16px;
      max-width: 1320px;
      margin:0 auto;
      min-height:100vh;
      align-items:stretch;
    }

    .sidebar, .main{
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 120%), var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      min-height:0;
    }

    .sidebar{ display:flex; flex-direction:column; min-height:0; }

    .sidebar-header{
      padding:14px 14px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 100%);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex:0 0 auto;
    }
    .brand{
      font-size:14px;
      letter-spacing:.6px;
      text-transform:uppercase;
      margin:0;
      color:var(--muted);
      font-weight:800;
    }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      color:rgba(233,238,252,.85);
      background:rgba(122,162,255,.12);
      border:1px solid rgba(122,162,255,.25);
      padding:6px 10px;
      border-radius:999px;
      user-select:none;
      white-space:nowrap;
    }

    .list{
      padding:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:auto;
      flex:1 1 auto;
      min-height:0;
    }

    .raven-item{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 70%), var(--panel2);
      border-radius: var(--r2);
      padding:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .raven-item:hover{ transform: translateY(-1px); border-color: rgba(122,162,255,.32); }
    .raven-item.active{ border-color: rgba(122,162,255,.65); box-shadow: 0 0 0 3px rgba(122,162,255,.10); }

    .raven-img{
      width: 70px;
      height: 70px;
      object-fit: cover;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      display:block;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      flex:0 0 auto;
    }

    .raven-right{ flex:1 1 auto; min-width:0; }
    .raven-top{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; }
    .raven-name{ margin:0; font-weight:900; font-size:14px; }
    .tiny{ margin-top:2px; font-size:12px; color:var(--muted); }

    .status{
      font-size:12px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:rgba(233,238,252,.85);
      user-select:none;
      white-space:nowrap;
      flex:0 0 auto;
    }
    .status.ok{ border-color: rgba(79,227,163,.35); background: rgba(79,227,163,.10); }
    .status.hurt{ border-color: rgba(255,107,122,.35); background: rgba(255,107,122,.10); }
    .status.out{ border-color: rgba(159,176,208,.25); background: rgba(159,176,208,.08); }

    .main{ display:flex; flex-direction:column; min-height:0; }
    .main-top{
      padding:14px 16px 12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 100%);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex:0 0 auto;
    }

    .title-wrap{ display:flex; gap:14px; align-items:flex-start; }
    .title-col h2{ margin:0; font-size:16px; letter-spacing:.2px; }
    .subline{ margin-top:3px; color:var(--muted); font-size:12px; }

    .head-avatar{
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
      flex:0 0 auto;
    }

    .top-tools{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
      align-items:flex-start;
    }

    .btn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
      font-size:13px;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(255,255,255,.18); }

    .hud{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .tile{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      user-select:none;
      min-width: 175px;
    }
    .tile .ico{
      width:32px;height:32px;
      border-radius:12px;
      display:grid;
      place-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      font-size:16px;
    }
    .tile .col{
      display:flex;
      flex-direction:column;
      line-height:1.05;
      gap:6px;
      min-width: 120px;
    }
    .tile .top{
      display:flex;
      gap:10px;
      align-items:baseline;
      justify-content:space-between;
      font-family:var(--mono);
      font-weight:900;
      letter-spacing:.2px;
    }
    .tile .top small{
      font-family:var(--sans);
      font-weight:900;
      font-size:11px;
      letter-spacing:.6px;
      text-transform:uppercase;
      opacity:.7;
    }

    .tile-kz{ border:1px solid rgba(122,162,255,.26); background: rgba(122,162,255,.08); }
    .tile-kz:hover{ border-color: rgba(122,162,255,.42); }
    .tile-speed{ border:1px solid rgba(122,162,255,.20); background: rgba(122,162,255,.06); }
    .tile-speed:hover{ border-color: rgba(122,162,255,.35); }

    .tile-hp{
      border:1px solid rgba(79,227,163,.26);
      background: rgba(79,227,163,.08);
      min-width: 175px;
    }
    .tile-hp:hover{ border-color: rgba(79,227,163,.42); }
    .tile-hp.bad{ border-color: rgba(255,107,122,.35); background: rgba(255,107,122,.10); }
    .tile-hp .val{
      font-family:var(--mono);
      font-weight:900;
      letter-spacing:.2px;
      white-space:nowrap;
    }

    .tabs{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      background: rgba(0,0,0,.10);
      flex:0 0 auto;
    }
    .tab{
      border:none;
      cursor:pointer;
      background: transparent;
      color: rgba(233,238,252,.80);
      font-weight:900;
      letter-spacing:.3px;
      padding:10px 10px;
      border-radius:12px;
      text-transform:uppercase;
      font-size:12px;
      user-select:none;
    }
    .tab:hover{ background: rgba(255,255,255,.03); }
    .tab.active{
      background: rgba(122,162,255,.12);
      border:1px solid rgba(122,162,255,.35);
      color: rgba(233,238,252,.95);
    }

    .page{
      padding:14px;
      overflow:auto;
      flex:1 1 auto;
      min-height:0;
    }

    .panel{
      border:1px solid var(--line);
      border-radius: var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.02), transparent 80%), rgba(255,255,255,.01);
      overflow:hidden;
      margin-bottom:12px;
    }
    .panel-h{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.10);
    }
    .panel-h b{ font-size:13px; letter-spacing:.2px; }
    .panel-b{ padding:12px; }

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
    }
    .field{ grid-column: span 4; display:flex; flex-direction:column; gap:6px; }
    .field.w6{ grid-column: span 6; }
    .field.w12{ grid-column: span 12; }

    label{ font-size:12px; color: var(--muted); }
    input[type="text"], input[type="number"], textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    textarea{ min-height: 160px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 0 0 3px rgba(122,162,255,.12);
    }

    .table{ display:flex; flex-direction:column; gap:10px; }
    .row-item{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:10px;
      display:grid;
      grid-template-columns: 1.2fr 0.55fr 0.85fr 42px;
      gap:10px;
      align-items:center;
    }
    .row-item .name{
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .row-item .name:hover{ text-decoration: underline; }

    .chip{
      font-family: var(--mono);
      font-weight:900;
      border:1px solid rgba(122,162,255,.35);
      background: rgba(122,162,255,.10);
      border-radius:12px;
      padding:10px 12px;
      text-align:center;
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .chip:hover{ border-color: rgba(122,162,255,.55); }
    .chip.damage{
      border-color: rgba(255,255,255,.14);
      background: rgba(255,255,255,.03);
    }
    .chip.damage:hover{ border-color: rgba(255,255,255,.22); }

    .iconbtn{
      width:42px;height:42px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      display:grid;place-items:center;
      user-select:none;
    }
    .iconbtn:hover{ border-color: rgba(255,255,255,.18); }
    .iconbtn.danger{
      border-color: rgba(255,107,122,.35);
      background: rgba(255,107,122,.10);
    }

    .abilities-wrap{
      display:grid;
      grid-template-columns: 1.25fr 0.9fr;
      gap:12px;
    }
    .cards{ display:flex; flex-direction:column; gap:10px; }

    .statLSS{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      overflow:hidden;
    }
    .statLSS .h{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,.10);
    }
    .statLSS .h b{
      font-size:14px;
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    .statLSS .h .right{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .pillbtn{
      font-family:var(--mono);
      font-weight:900;
      border:1px solid rgba(122,162,255,.35);
      background: rgba(122,162,255,.10);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      user-select:none;
      min-width:56px;
      text-align:center;
    }
    .pillbtn:hover{ border-color: rgba(122,162,255,.55); }

    .scoreInput{
      width:64px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-family: var(--mono);
      font-weight:900;
      text-align:center;
      outline:none;
    }
    .scoreInput:focus{
      border-color: rgba(122,162,255,.55);
      box-shadow: 0 0 0 3px rgba(122,162,255,.12);
    }

    .statLSS .b{
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .skillRow{
      display:grid;
      grid-template-columns: 18px 1fr 60px;
      gap:10px;
      align-items:center;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.10);
      border-radius: 12px;
      padding:8px 10px;
    }
    .dotToggle{
      width:12px;height:12px;
      border-radius:999px;
      border:1px solid rgba(233,238,252,.20);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      user-select:none;
    }
    .dotToggle.on{
      border-color: rgba(79,227,163,.55);
      background: rgba(79,227,163,.30);
      box-shadow: 0 0 0 3px rgba(79,227,163,.10);
    }
    .skillRow .name{
      font-weight:800;
      color: rgba(233,238,252,.92);
      font-size:13px;
    }
    .skillRow .val{
      font-family:var(--mono);
      font-weight:900;
      text-align:right;
      opacity:.95;
      cursor:pointer;
      user-select:none;
    }
    .skillRow .val:hover{ text-decoration: underline; }

    @media (max-width: 1050px){
      .abilities-wrap{ grid-template-columns: 1fr; }
    }

    .lvl{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.01);
      border-radius: var(--r);
      overflow:hidden;
      margin-bottom:12px;
    }
    .lvl-h{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      background: rgba(0,0,0,.10);
    }
    .lvl-h b{ font-size:12px; text-transform:uppercase; letter-spacing:.4px; }
    .slots{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
    }
    .slot{
      width:12px;height:12px;border-radius:999px;
      border:1px solid rgba(233,238,252,.20);
      background: rgba(255,255,255,.02);
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease;
    }
    .slot:hover{ transform: translateY(-1px); border-color: rgba(122,162,255,.40); }
    .slot.used{
      border-color: rgba(122,162,255,.60);
      background: rgba(122,162,255,.30);
      box-shadow: 0 0 0 3px rgba(122,162,255,.10);
    }
    .lvl-b{ padding:12px; }

    .spell-row{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 14px;
      padding:10px;
      display:grid;
      grid-template-columns: 1.2fr 0.9fr 42px;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }

    .sp-gear{ display:flex; gap:8px; align-items:center; }
    .gearbtn{
      width:42px;height:42px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color:var(--text);
      cursor:pointer;
      font-weight:900;
      user-select:none;
      display:grid;place-items:center;
    }
    .gearbtn:hover{ border-color: rgba(255,255,255,.18); }

    .sp-settings{ display:none; margin-bottom:12px; }
    .sp-settings.open{ display:block; }

    .toast{
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(15,22,36,.92);
      border:1px solid rgba(255,255,255,.10);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: var(--shadow);
      display:none;
      gap:10px;
      align-items:center;
      z-index: 1200;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--ok);
      box-shadow: 0 0 0 4px rgba(79,227,163,.18);
    }

    .roll-pop{
      position:fixed;
      left: 16px;
      bottom: 16px;
      z-index: 1600;
      display:none;
      width: min(520px, calc(100vw - 32px));
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: radial-gradient(900px 300px at 30% 30%, rgba(122,162,255,.10), transparent 60%), rgba(10,14,22,.92);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .roll-head{
      padding:12px 14px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .roll-title{
      font-weight:900;
      letter-spacing:.3px;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(233,238,252,.90);
    }
    .roll-x{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 12px;
      width:38px;height:38px;
      cursor:pointer;
      display:grid;place-items:center;
      font-weight:900;
      user-select:none;
    }
    .roll-x:hover{ border-color: rgba(255,255,255,.18); }
    .roll-body{
      padding:14px;
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }
    .roll-left{ display:flex; flex-direction:column; gap:6px; }
    .roll-big{
      font-family: var(--mono);
      font-weight:900;
      font-size:44px;
      letter-spacing:.5px;
      color: rgba(233,238,252,.95);
    }
    .roll-sub{
      font-family: var(--mono);
      color: rgba(233,238,252,.75);
      font-size:12px;
      word-break:break-word;
    }

    .modal-back{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index: 2000;
    }
    .modal{
      width:min(760px, 100%);
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent 120%), var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .modal header{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modal header h3{
      margin:0;
      font-size:14px;
      color: rgba(233,238,252,.92);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .modal .body{ padding:16px; }
    .footer-actions{
      padding:14px 16px;
      border-top:1px solid var(--line);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      background: rgba(0,0,0,.10);
    }

    .mini{
      font-size:12px;
      color: var(--muted);
      line-height:1.35;
    }

    /* HP modal */
    .hp-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .hp-big{
      font-family: var(--mono);
      font-size:44px;
      font-weight:900;
      letter-spacing:.5px;
      display:flex;
      align-items:baseline;
      gap:10px;
    }
    .hp-big small{
      font-size:16px;
      color: var(--muted);
      font-weight:800;
    }
    .hp-grid{
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:14px;
      align-items:start;
    }
    .hp-input-row{
      display:grid;
      grid-template-columns: 1fr 52px;
      gap:10px;
      align-items:center;
      margin-bottom:10px;
    }
    .hp-input{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      font-family: var(--mono);
      font-weight:900;
      font-size:18px;
      letter-spacing:.4px;
      color: rgba(233,238,252,.95);
      text-align:right;
      user-select:none;
    }
    .hp-back{
      width:52px;height:52px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      cursor:pointer;
      display:grid;place-items:center;
      font-weight:900;
      user-select:none;
    }
    .hp-back:hover{ border-color: rgba(255,255,255,.18); }

    .keypad{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    .key{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius:12px;
      padding:14px 0;
      text-align:center;
      font-weight:900;
      font-family: var(--mono);
      cursor:pointer;
      user-select:none;
    }
    .key:hover{ border-color: rgba(255,255,255,.18); }
    .key.blue{ border-color: rgba(122,162,255,.40); background: rgba(122,162,255,.10); }

    .actions-col{ display:flex; flex-direction:column; gap:10px; }
    .act{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:12px 12px;
      cursor:pointer;
      font-weight:900;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .act:hover{ border-color: rgba(255,255,255,.18); }
    .act.red{ border-color: rgba(255,107,122,.35); background: rgba(255,107,122,.10); }
    .act.green{ border-color: rgba(79,227,163,.35); background: rgba(79,227,163,.10); }
    .act.blue{ border-color: rgba(122,162,255,.40); background: rgba(122,162,255,.10); }

    .hp-settings{
      margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:14px;
      display:none;
    }
    .hp-settings.open{ display:block; }

    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .hp-grid{ grid-template-columns: 1fr; }
      .row-item{ grid-template-columns: 1fr; }
      .chip{ text-align:left; }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="brand">RAVENS SHEET</div>
        <div class="pill" id="saveState">autosave</div>
      </div>
      <div class="list" id="ravenList"></div>
    </aside>

    <main class="main">
      <div class="main-top">
        <div class="title-wrap">
          <img id="headAvatar" class="head-avatar" alt="raven" />
          <div class="title-col">
            <h2 id="title">‚Äî</h2>
            <div class="subline" id="subtitle">‚Äî</div>
          </div>
        </div>

        <div class="top-tools">
          <div class="hud">
            <div class="tile tile-kz" id="kzTile" title="–ö–ó">
              <div class="ico">üõ°Ô∏è</div>
              <div class="col">
                <div class="top">
                  <small>–ö–ó</small>
                  <span id="kzVal">10</span>
                </div>
              </div>
            </div>

            <div class="tile tile-speed" id="speedTile" title="–°–∫–æ—Ä–æ—Å—Ç—å –∏ –ø–æ–ª—ë—Ç">
              <div class="ico">üèÉ</div>
              <div class="col">
                <div class="top">
                  <small>–°–∫–æ—Ä–æ—Å—Ç—å</small>
                  <span id="speedVal">10 / ‚úà 30</span>
                </div>
              </div>
            </div>

            <div class="tile tile-hp" id="hpTile" title="–•–∏—Ç—ã">
              <div class="ico">„Ä∞</div>
              <div class="val" id="hpVal">0/0</div>
            </div>
          </div>

          <button class="btn" id="prevBtn">‚Üê</button>
          <button class="btn" id="nextBtn">‚Üí</button>
          <button class="btn" id="roomBtn" title="–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ/—Å—Å—ã–ª–∫–∞">üîë</button>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <button class="tab active" data-tab="attacks">–ê—Ç–∞–∫–∏</button>
        <button class="tab" data-tab="abilities">–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</button>
        <button class="tab" data-tab="notes">–ó–∞–º–µ—Ç–∫–∏</button>
        <button class="tab" data-tab="spells">–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</button>
      </div>

      <div class="page" id="page"></div>
    </main>
  </div>

  <div class="toast" id="toast">
    <div class="dot"></div>
    <div id="toastText">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
  </div>

  <div class="roll-pop" id="rollPop">
    <div class="roll-head">
      <div class="roll-title" id="rollTitle">–ë–†–û–°–û–ö</div>
      <div class="roll-x" id="rollClose">√ó</div>
    </div>
    <div class="roll-body">
      <div class="roll-left">
        <div class="roll-big" id="rollBig">0</div>
        <div class="roll-sub" id="rollSub">(1d20)+0</div>
      </div>
      <div class="mini" id="rollExtra"></div>
    </div>
  </div>

  <!-- Room Modal -->
  <div class="modal-back" id="roomBack">
    <div class="modal" style="max-width:620px;">
      <header>
        <h3>üîë –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –æ–±—â–µ–º—É –ª–∏—Å—Ç—É</h3>
        <button class="btn" id="roomClose" style="padding:10px 12px;">√ó</button>
      </header>
      <div class="body">
        <div class="grid">
          <div class="field w12">
            <label>Room Key</label>
            <input type="text" id="roomKeyInput" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: raven-42-secret" />
            <div class="mini" style="margin-top:10px;">
              –£ –∫–æ–≥–æ –µ—Å—Ç—å —ç—Ç–æ—Ç –∫–ª—é—á ‚Äî —Ç–æ—Ç –≤–∏–¥–∏—Ç –∏ –º–µ–Ω—è–µ—Ç –æ–±—â–∏–π –ª–∏—Å—Ç.
            </div>
          </div>
          <div class="field w12">
            <label>–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ</label>
            <input type="text" id="inviteLink" readonly />
            <div class="mini" style="margin-top:10px;">
              –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥—Ä—É–≥—É ‚Äî –æ–Ω –∑–∞–π–¥—ë—Ç –∏ —Å—Ä–∞–∑—É –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è.
            </div>
          </div>
        </div>
      </div>
      <div class="footer-actions">
        <button class="btn" id="copyInvite">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button class="btn" id="roomOk">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      </div>
    </div>
  </div>

  <!-- HP Modal -->
  <div class="modal-back" id="hpBack">
    <div class="modal">
      <header>
        <h3>‚ù§Ô∏è –•–∏—Ç—ã</h3>
        <div style="display:flex; gap:8px; align-items:center;">
          <button class="btn" id="hpGear" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏" style="padding:10px 12px;">‚öô</button>
          <button class="btn" id="hpClose" title="–ó–∞–∫—Ä—ã—Ç—å" style="padding:10px 12px;">√ó</button>
        </div>
      </header>

      <div class="body">
        <div class="hp-top">
          <div class="hp-big">
            <span id="hpBig">0/0</span>
            <small id="hpTemp">+0</small>
          </div>
          <div class="mini">–ù–∞–±–µ—Ä–∏ —á–∏—Å–ª–æ ‚Üí –Ω–∞–∂–º–∏ –¥–µ–π—Å—Ç–≤–∏–µ</div>
        </div>

        <div class="hp-grid">
          <div>
            <div class="hp-input-row">
              <div class="hp-input" id="hpInput">0</div>
              <div class="hp-back" id="hpBackspace">‚å´</div>
            </div>

            <div class="keypad" id="keypad">
              <div class="key" data-k="7">7</div>
              <div class="key" data-k="8">8</div>
              <div class="key" data-k="9">9</div>
              <div class="key" data-k="4">4</div>
              <div class="key" data-k="5">5</div>
              <div class="key" data-k="6">6</div>
              <div class="key" data-k="1">1</div>
              <div class="key" data-k="2">2</div>
              <div class="key" data-k="3">3</div>
              <div class="key" data-k="0">0</div>
              <div class="key blue" data-k="clr">C</div>
              <div class="key blue" data-k="00">00</div>
            </div>

            <div class="hp-settings" id="hpSettings">
              <div class="grid">
                <div class="field w6">
                  <label>–ú–∞–∫—Å–∏–º—É–º —Ö–∏—Ç–æ–≤</label>
                  <input type="number" id="setHpMax" min="0" max="999" />
                </div>
                <div class="field w6">
                  <label>–ë–æ–Ω—É—Å –∫ –º–∞–∫—Å–∏–º—É–º—É</label>
                  <input type="number" id="setHpBonus" min="-99" max="999" />
                </div>
              </div>
            </div>
          </div>

          <div class="actions-col">
            <div class="act blue" id="actTemp">üõ° –í—Ä–µ–º–µ–Ω–Ω—ã–µ</div>
            <div class="act green" id="actHeal">üíö –õ–µ—á–µ–Ω–∏–µ</div>
            <div class="act red" id="actDmg">ü©∏ –£—Ä–æ–Ω</div>
            <div class="act" id="actClear">‚Ü© –°–±—Ä–æ—Å –≤–≤–æ–¥–∞</div>
          </div>
        </div>
      </div>

      <div class="footer-actions">
        <button class="btn" id="hpDone">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <!-- KZ Modal -->
  <div class="modal-back" id="kzBack">
    <div class="modal" style="max-width:520px;">
      <header>
        <h3>üõ° –ö–ó</h3>
        <button class="btn" id="kzClose" style="padding:10px 12px;">√ó</button>
      </header>
      <div class="body">
        <div class="grid">
          <div class="field w12">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ö–ó</label>
            <input type="number" id="kzInput" min="0" max="99" placeholder="10" />
          </div>
        </div>
      </div>
      <div class="footer-actions">
        <button class="btn" id="kzOk">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <!-- Speed Modal -->
  <div class="modal-back" id="spdBack">
    <div class="modal" style="max-width:620px;">
      <header>
        <h3>üèÉ –°–∫–æ—Ä–æ—Å—Ç—å</h3>
        <button class="btn" id="spdClose" style="padding:10px 12px;">√ó</button>
      </header>
      <div class="body">
        <div class="grid">
          <div class="field w6">
            <label>–û–±—ã—á–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å</label>
            <input type="number" id="spdInput" min="0" max="999" />
          </div>
          <div class="field w6">
            <label>–°–∫–æ—Ä–æ—Å—Ç—å –ø–æ–ª—ë—Ç–∞</label>
            <input type="number" id="flyInput" min="0" max="999" />
          </div>
        </div>
      </div>
      <div class="footer-actions">
        <button class="btn" id="spdOk">–ì–æ—Ç–æ–≤–æ</button>
      </div>
    </div>
  </div>

  <!-- Attack Editor Modal -->
  <div class="modal-back" id="atkBack">
    <div class="modal" style="max-width:760px;">
      <header>
        <h3>‚öî –†–µ–¥–∞–∫—Ç–æ—Ä –∞—Ç–∞–∫–∏</h3>
        <button class="btn" id="atkClose" style="padding:10px 12px;">√ó</button>
      </header>
      <div class="body">
        <div class="grid">
          <div class="field w6">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input type="text" id="atkEditName" />
          </div>
          <div class="field">
            <label>–ë–æ–Ω—É—Å</label>
            <input type="text" id="atkEditBonus" placeholder="+6" />
          </div>
          <div class="field w6">
            <label>–£—Ä–æ–Ω/–≤–∏–¥</label>
            <input type="text" id="atkEditDamage" placeholder="1–∫6+3 –∫–æ–ª—é—â–∏–π" />
          </div>
        </div>
      </div>
      <div class="footer-actions">
        <button class="btn" id="atkSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ==========================
  // 1) –ù–ê–°–¢–†–û–ô–ö–ò
  // ==========================

  // Discord webhook (–∫–∞–∫ —Ç—ã –¥–∞–ª)
  const DISCORD_WEBHOOK_URL = "https://discord.com/api/webhooks/1378422584298967090/x49r-Dn73Xt0Xd9Lr0mAOxJ6M3lFepbsfKyJosDILOCLC5PtPJjS-AS7XJJmZaC3akyx";

  // Supabase (–í–°–¢–ê–í–¨ –°–í–û–ò)
  const SUPABASE_URL = "https://tdkpkuaerlmknpsimves.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRka3BrdWFlcmxta25wc2ltdmVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwMjI4NzEsImV4cCI6MjA4NTU5ODg3MX0.RfGzt8d46sy3EIpH5AUSL_PUqG7f59UGhK-d-aLB8dw";

  // Local storage keys
  const STORAGE_KEY_LOCAL = "ravens_sheet_local_v1";
  const ROOM_KEY_STORAGE = "ravens_room_key_v1";

  // ==========================
  // 2) –£–¢–ò–õ–ò–¢–´
  // ==========================
  const clamp = (n,a,b)=> Number.isNaN(n)?a:Math.max(a,Math.min(b,n));
  function rid(){
    const a = new Uint8Array(8);
    crypto.getRandomValues(a);
    return [...a].map(x => x.toString(16).padStart(2,'0')).join('');
  }
  function esc(s){
    return String(s??"").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function escAttr(s){ return esc(s).replaceAll("\n"," "); }
  function fmt(ts){
    const d = new Date(ts);
    const p = n => String(n).padStart(2,"0");
    return `${p(d.getDate())}.${p(d.getMonth()+1)}.${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }

  // Dice
  function rollDie(sides){ return Math.floor(Math.random()*sides)+1; }
  function parseDiceExpression(text){
    const t = String(text ?? "").trim();
    const diceRe = /(\d*)\s*[dDkK–∫–ö]\s*(\d+)/g;
    let m, dice = [];
    while((m = diceRe.exec(t)) !== null){
      const n = m[1] ? Number(m[1]) : 1;
      const sides = Number(m[2]);
      if(!Number.isFinite(n) || !Number.isFinite(sides) || sides <= 0) continue;
      dice.push({n, sides});
    }
    const modRe = /([+-])\s*(\d+)/g;
    let mod = 0;
    while((m = modRe.exec(t)) !== null){
      const sign = m[1];
      const val = Number(m[2]);
      mod += (sign === "-") ? -val : val;
    }
    if(dice.length === 0){
      const numMatch = t.match(/-?\d+/);
      if(numMatch){
        const v = Number(numMatch[0]);
        return { dice: [], mod: 0, constant: v, raw: t };
      }
      return { dice: [], mod: 0, constant: 0, raw: t };
    }
    return { dice, mod, constant: null, raw: t };
  }
  function rollFromParsed(p){
    if(p.constant !== null){
      return { total: p.constant, detail: String(p.constant) };
    }
    let total = 0;
    const parts = [];
    for(const d of p.dice){
      const rolls = [];
      for(let i=0;i<d.n;i++){
        const r = rollDie(d.sides);
        rolls.push(r);
        total += r;
      }
      parts.push(`${d.n}d${d.sides}=[${rolls.join(",")}]`);
    }
    if(p.mod){
      total += p.mod;
      parts.push((p.mod>0?`+${p.mod}`:`${p.mod}`));
    }
    return { total, detail: parts.join(" ") };
  }
  function rollD20Plus(bonus){
    const d = rollDie(20);
    const b = Number(bonus)||0;
    const total = d + b;
    const detail = `(1d20)=${d} ${(b>=0?`+${b}`:String(b))}`;
    return { total, detail };
  }
  function parsedToShort(p){
    if(p.constant !== null) return String(p.constant);
    const dice = p.dice.map(d => `${d.n}d${d.sides}`).join("+");
    const mod = p.mod ? (p.mod>0?`+${p.mod}`:`${p.mod}`) : "";
    return `${dice}${mod}`;
  }
  function parseBonusNumber(text){
    const t = String(text??"").trim().replace(",",".");
    const m = t.match(/-?\d+/);
    return m ? Number(m[0]) : 0;
  }

  // Discord Embed
  async function sendRollToDiscord({title,total,detail,extra, ravenName, ravenImg}) {
    if(!DISCORD_WEBHOOK_URL) return;

    // –ù–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏ —Å—Ç–∞–Ω—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –ø–æ URL
    let base = "";
    try { base = location.origin; } catch { base = ""; }
    const imgUrl = (base && ravenImg) ? `${base}/${ravenImg}` : null;

    const embed = {
      color: 0x000000,
      author: {
        name: ravenName ? ravenName : "–í–æ—Ä–æ–Ω",
        icon_url: imgUrl || undefined
      },
      title: `${title} ‚Äî ${total}`,
      description: extra ? `**${extra}**` : undefined,
      fields: [
        { name: "–§–æ—Ä–º—É–ª–∞", value: detail ? `\`${detail}\`` : "`‚Äî`", inline: false }
      ],
      thumbnail: imgUrl ? { url: imgUrl } : undefined
    };

    const payload = { embeds: [embed] };

    // ‚ö†Ô∏è –ò–Ω–æ–≥–¥–∞ Discord —Ä–µ–∂–µ—Ç –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã (CORS/–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è).
    // –ï—Å–ª–∏ –≤–¥—Ä—É–≥ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ Vercel ‚Äî —Å–∫–∞–∂–∏, —è –¥–∞–º –º–∏–Ω–∏-–ø—Ä–æ–∫—Å–∏ (/api/discord) –¥–ª—è Vercel.
    try{
      await fetch(DISCORD_WEBHOOK_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload),
      });
    }catch(e){
      console.warn("Discord send failed:", e);
    }
  }

  // ==========================
  // 3) –î–ê–ù–ù–´–ï
  // ==========================
  function makeRaven(name, role, img){
    return {
      id: rid(),
      name,
      role,
      img,
      status: "ok",
      kz: 10,
      speed: 10,
      fly: 30,
      passive: 12,
      hp: { current: 9, max: 9, temp: 0, bonusMax: 0 },
      stats: { str: 10, dex: 10, con: 10, int: 10, wis: 10, cha: 10 },
      prof: {
        athletics:false, acrobatics:false, sleight:false, stealth:false,
        arcana:false, history:false, investigation:false, nature:false, religion:false,
        animal:false, insight:false, medicine:false, perception:false, survival:false,
        deception:false, intimidation:false, performance:false, persuasion:false
      },
      attacks: [],
      abilitiesText: "",
      notesText: "",
      spells: [],
      slots: (()=>{ const o={}; for(let i=0;i<=9;i++) o[i]={max:null, used:0}; return o; })()
    };
  }

  const DEFAULT = {
    meta: { characterName: "–ü–µ—Ä—Å–æ–Ω–∞–∂", campaign: "–ö–∞–º–ø–∞–Ω–∏—è", updatedAt: Date.now() },
    ravens: [
      makeRaven("–ö—Ä–∞—Ä-–∫—Ä–∞—Ä", "–†–∞–∑–≤–µ–¥—á–∏–∫", "Krar-Krar.png"),
      makeRaven("–ö–∞—Ä-–∫–∞—Ä", "–ü–æ—Å–ª–∞–Ω–Ω–∏–∫", "Kar-kar.png"),
      makeRaven("–ö—è—Ä-–ö—è—Ä", "–®–ø–∏–æ–Ω", "Kyar-Kyar.png"),
      makeRaven("–ö–∏–±—Ä–∞–≥–∏–º", "–ë–æ–µ—Ü", "Kibragim.png")
    ]
  };

  function ensureSlots(r,lvl){
    r.slots = r.slots || {};
    if(!r.slots[lvl]) r.slots[lvl] = {max:null, used:0};
  }

  function normalizeRaven(r){
    const def = makeRaven(r.name||"–í–æ—Ä–æ–Ω", r.role||"‚Äî", r.img||"");
    const out = {...def, ...r};

    out.hp = {...def.hp, ...(r.hp||{})};
    out.hp.current = clamp(Number(out.hp.current||0),0,999);
    out.hp.max = clamp(Number(out.hp.max||0),0,999);
    out.hp.temp = clamp(Number(out.hp.temp||0),0,999);
    out.hp.bonusMax = clamp(Number(out.hp.bonusMax||0),-99,999);

    out.kz = clamp(Number(out.kz ?? 10),0,99);
    out.speed = clamp(Number(out.speed||0),0,999);
    out.fly = clamp(Number(out.fly||0),0,999);
    out.passive = clamp(Number(out.passive||0),0,50);

    out.attacks = Array.isArray(out.attacks) ? out.attacks : [];
    out.spells = Array.isArray(out.spells) ? out.spells : [];

    out.stats = {...def.stats, ...(r.stats||{})};
    for(const k of ["str","dex","con","int","wis","cha"]){
      out.stats[k] = clamp(Number(out.stats[k] ?? 10),1,30);
    }

    out.prof = {...def.prof, ...(r.prof||{})};

    out.slots = out.slots || def.slots;
    for(let lvl=0; lvl<=9; lvl++){
      ensureSlots(out,lvl);
      const m = out.slots[lvl].max;
      if(m === "" || m === undefined) out.slots[lvl].max = null;
      if(out.slots[lvl].max !== null){
        out.slots[lvl].max = clamp(Number(out.slots[lvl].max),0,20);
        out.slots[lvl].used = clamp(Number(out.slots[lvl].used||0),0,out.slots[lvl].max);
      } else {
        out.slots[lvl].used = 0;
      }
    }
    return out;
  }

  function normalizeIncomingState(incoming){
    try{
      const parsed = incoming;
      if(!parsed || !Array.isArray(parsed.ravens)) return structuredClone(DEFAULT);

      const base = structuredClone(DEFAULT);
      base.meta = {...base.meta, ...(parsed.meta||{})};

      const inc = parsed.ravens.slice(0,4);
      for(let i=0;i<4;i++){
        const def = base.ravens[i];
        const got = inc[i] || {};
        base.ravens[i] = normalizeRaven({...def, ...got});
        base.ravens[i].name = base.ravens[i].name || def.name;
        base.ravens[i].role = base.ravens[i].role || def.role;
        base.ravens[i].img  = base.ravens[i].img  || def.img;
      }
      base.meta.updatedAt = base.meta.updatedAt || Date.now();
      return base;
    }catch{
      return structuredClone(DEFAULT);
    }
  }

  function loadLocal(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY_LOCAL);
      if(!raw) return structuredClone(DEFAULT);
      const parsed = JSON.parse(raw);
      return normalizeIncomingState(parsed);
    }catch{
      return structuredClone(DEFAULT);
    }
  }

  // ==========================
  // 4) SUPABASE
  // ==========================
  const supa = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY);

  let roomKey = localStorage.getItem(ROOM_KEY_STORAGE) || "";
  let serverReady = false;
  let cloudSaveTimer = null;

  function getRoomFromURL(){
    const u = new URL(location.href);
    const r = u.searchParams.get("room");
    return r ? r.trim() : "";
  }
  function setRoomInURL(key){
    const u = new URL(location.href);
    if(key) u.searchParams.set("room", key);
    else u.searchParams.delete("room");
    history.replaceState(null, "", u.toString());
  }

  async function cloudLoad(){
    if(!supa || !roomKey) return false;
    try{
      const { data, error } = await supa
        .from("ravens_sheet")
        .select("data")
        .eq("room_key", roomKey)
        .maybeSingle();

      if(error) throw error;

      if(data?.data){
        state = normalizeIncomingState(data.data);
        selectedId = state.ravens[0]?.id ?? selectedId;
        serverReady = true;
        renderAll();
        showToast("–ó–∞–≥—Ä—É–∂–µ–Ω–æ (–æ–±—â–µ–µ)");
        return true;
      } else {
        await cloudSave(true); // —Å–æ–∑–¥–∞—Ç—å –∑–∞–ø–∏—Å—å
        serverReady = true;
        showToast("–°–æ–∑–¥–∞–Ω –æ–±—â–∏–π –ª–∏—Å—Ç");
        return true;
      }
    }catch(e){
      console.error("cloudLoad error", e);
      showToast("–û—à–∏–±–∫–∞ Supabase");
      return false;
    }
  }

  async function cloudSave(force=false){
    if(!supa || !roomKey) return;
    if(!serverReady && !force) return;

    const payload = {
      room_key: roomKey,
      data: state,
      updated_at: new Date().toISOString()
    };

    try{
      const { error } = await supa
        .from("ravens_sheet")
        .upsert(payload, { onConflict: "room_key" });

      if(error) throw error;
    }catch(e){
      console.error("cloudSave error", e);
    }
  }

  // ==========================
  // 5) –°–û–°–¢–û–Ø–ù–ò–ï + DOM
  // ==========================
  let state = loadLocal();
  let selectedId = state.ravens[0]?.id ?? null;
  let activeTab = "attacks";
  let spSettingsOpen = false;

  const elList = document.getElementById("ravenList");
  const elTitle = document.getElementById("title");
  const elSubtitle = document.getElementById("subtitle");
  const elTabs = document.getElementById("tabs");
  const elPage = document.getElementById("page");
  const elSaveState = document.getElementById("saveState");
  const headAvatar = document.getElementById("headAvatar");
  const roomBtn = document.getElementById("roomBtn");

  const btnPrev = document.getElementById("prevBtn");
  const btnNext = document.getElementById("nextBtn");

  const kzTile = document.getElementById("kzTile");
  const speedTile = document.getElementById("speedTile");
  const kzVal = document.getElementById("kzVal");
  const speedVal = document.getElementById("speedVal");

  const hpTile = document.getElementById("hpTile");
  const hpVal = document.getElementById("hpVal");

  const toast = document.getElementById("toast");
  const toastText = document.getElementById("toastText");

  const rollPop = document.getElementById("rollPop");
  const rollTitle = document.getElementById("rollTitle");
  const rollBig = document.getElementById("rollBig");
  const rollSub = document.getElementById("rollSub");
  const rollExtra = document.getElementById("rollExtra");
  const rollClose = document.getElementById("rollClose");

  // Room modal
  const roomBack = document.getElementById("roomBack");
  const roomKeyInput = document.getElementById("roomKeyInput");
  const inviteLink = document.getElementById("inviteLink");
  const copyInvite = document.getElementById("copyInvite");
  const roomOk = document.getElementById("roomOk");
  const roomClose = document.getElementById("roomClose");

  // HP modal
  const hpBack = document.getElementById("hpBack");
  const hpBig = document.getElementById("hpBig");
  const hpTemp = document.getElementById("hpTemp");
  const hpInput = document.getElementById("hpInput");
  const keypad = document.getElementById("keypad");
  const hpGear = document.getElementById("hpGear");
  const hpSettings = document.getElementById("hpSettings");
  const setHpMax = document.getElementById("setHpMax");
  const setHpBonus = document.getElementById("setHpBonus");
  const hpClose = document.getElementById("hpClose");
  const hpDone = document.getElementById("hpDone");
  const hpBackspace = document.getElementById("hpBackspace");
  const actTemp = document.getElementById("actTemp");
  const actHeal = document.getElementById("actHeal");
  const actDmg  = document.getElementById("actDmg");
  const actClear = document.getElementById("actClear");
  let hpDraftInput = "0";

  // KZ modal
  const kzBack = document.getElementById("kzBack");
  const kzInput = document.getElementById("kzInput");
  const kzClose = document.getElementById("kzClose");
  const kzOk = document.getElementById("kzOk");

  // Speed modal
  const spdBack = document.getElementById("spdBack");
  const spdInput = document.getElementById("spdInput");
  const flyInput = document.getElementById("flyInput");
  const spdClose = document.getElementById("spdClose");
  const spdOk = document.getElementById("spdOk");

  // Attack editor
  const atkBack = document.getElementById("atkBack");
  const atkClose = document.getElementById("atkClose");
  const atkSave = document.getElementById("atkSave");
  const atkEditName = document.getElementById("atkEditName");
  const atkEditBonus = document.getElementById("atkEditBonus");
  const atkEditDamage = document.getElementById("atkEditDamage");
  let atkEditingId = null;

  // ==========================
  // 6) –†–ï–ù–î–ï–†
  // ==========================
  function getSel(){ return state.ravens.find(r=>r.id===selectedId) || null; }

  function statusLabel(r){
    if(r.status==="hurt") return "—Ä–∞–Ω–µ–Ω";
    if(r.status==="out") return "–≤–Ω–µ –∏–≥—Ä—ã";
    return "–≤ —Å—Ç—Ä–æ—é";
  }

  function trueMax(r){
    return clamp(Number(r.hp.max||0) + Number(r.hp.bonusMax||0), 0, 999);
  }
  function hpLabel(r){
    const max = trueMax(r);
    return (r.hp.temp>0) ? `${r.hp.current}/${max}  +${r.hp.temp}` : `${r.hp.current}/${max}`;
  }
  function isLow(r){
    const m = trueMax(r);
    if(m<=0) return false;
    return r.hp.current <= Math.floor(m*0.3);
  }

  function statMod(score){
    const s = Number(score)||10;
    return Math.floor((s - 10)/2);
  }
  function statName(key){
    return ({str:"–°–∏–ª–∞", dex:"–õ–æ–≤–∫–æ—Å—Ç—å", con:"–¢–µ–ª–æ—Å–ª–æ–∂–µ–Ω–∏–µ", int:"–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç", wis:"–ú—É–¥—Ä–æ—Å—Ç—å", cha:"–•–∞—Ä–∏–∑–º–∞"})[key] || key;
  }

  function renderList(){
    elList.innerHTML = "";
    state.ravens.forEach(r => {
      const item = document.createElement("div");
      item.className = "raven-item" + (r.id===selectedId ? " active":"");
      item.addEventListener("click", ()=>{ selectedId=r.id; renderAll(); });

      const img = document.createElement("img");
      img.className = "raven-img";
      img.src = r.img || "";
      img.alt = r.name;

      const right = document.createElement("div");
      right.className = "raven-right";

      const top = document.createElement("div");
      top.className = "raven-top";

      const left = document.createElement("div");
      left.style.minWidth = "0";
      left.innerHTML = `<p class="raven-name">${esc(r.name)}</p><div class="tiny">${esc(r.role||"‚Äî")}</div>`;

      const st = document.createElement("div");
      st.className = "status " + (r.status||"ok");
      st.textContent = statusLabel(r);

      top.appendChild(left);
      top.appendChild(st);
      right.appendChild(top);

      item.appendChild(img);
      item.appendChild(right);
      elList.appendChild(item);
    });
  }

  function renderTop(){
    const r = getSel();
    if(!r){
      elTitle.textContent = "‚Äî";
      elSubtitle.textContent = "‚Äî";
      headAvatar.style.display = "none";
      return;
    }
    elTitle.textContent = r.name;
    elSubtitle.textContent = `${state.meta.characterName} ‚Ä¢ ${state.meta.campaign} ‚Ä¢ ${fmt(state.meta.updatedAt)}`;
    headAvatar.style.display = "block";
    headAvatar.src = r.img || "";
    headAvatar.alt = r.name;
  }

  function renderTabs(){
    elTabs.querySelectorAll(".tab").forEach(b => {
      b.classList.toggle("active", b.dataset.tab===activeTab);
    });
  }

  function renderHud(){
    const r = getSel();
    if(!r) return;

    kzVal.textContent = String(r.kz ?? 10);
    speedVal.textContent = `${Number(r.speed ?? 0)} / ‚úà ${Number(r.fly ?? 0)}`;
    hpVal.textContent = hpLabel(r);
    hpTile.classList.toggle("bad", isLow(r));
  }

  function profilePanel(r){
    return `
      <div class="panel">
        <div class="panel-h"><b>–ü—Ä–æ—Ñ–∏–ª—å</b></div>
        <div class="panel-b">
          <div class="grid">
            <div class="field w6">
              <label>–ò–º—è</label>
              <input type="text" data-k="name" value="${escAttr(r.name)}" />
            </div>
            <div class="field w6">
              <label>–†–æ–ª—å/–∑–∞–¥–∞—á–∞</label>
              <input type="text" data-k="role" value="${escAttr(r.role||"")}" />
            </div>

            <div class="field">
              <label>–°—Ç–∞—Ç—É—Å</label>
              <select data-k="status">
                <option value="ok" ${r.status==="ok"?"selected":""}>–í —Å—Ç—Ä–æ—é</option>
                <option value="hurt" ${r.status==="hurt"?"selected":""}>–†–∞–Ω–µ–Ω</option>
                <option value="out" ${r.status==="out"?"selected":""}>–í—ã–≤–µ–¥–µ–Ω</option>
              </select>
            </div>

            <div class="field">
              <label>–ü–∞—Å—Å–∏–≤–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ</label>
              <input type="number" min="0" max="50" data-k="passive" value="${Number(r.passive||0)}" />
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function attacksPage(r){
    const rows = (r.attacks||[]).map(a => `
      <div class="row-item" data-id="${a.id}">
        <div>
          <div class="name atk-name">${esc(a.name||"‚Äî")}</div>
          <div class="mini">${esc(a.damage||"")}</div>
        </div>

        <div class="chip atk-bonus">${esc(a.bonus||"0")}</div>
        <div class="chip damage atk-dmgchip">${esc(a.damage||"‚Äî")}</div>
        <div class="iconbtn danger" data-act="del">‚àí</div>
      </div>
    `).join("");

    return `
      ${profilePanel(r)}

      <div class="panel">
        <div class="panel-h"><b>–ê—Ç–∞–∫–∏</b></div>
        <div class="panel-b">
          <div class="grid" style="margin-bottom:12px;">
            <div class="field w6">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" id="newAtkName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–ª—é–≤" />
            </div>
            <div class="field">
              <label>–ë–æ–Ω—É—Å</label>
              <input type="text" id="newAtkBonus" placeholder="+5" />
            </div>
            <div class="field w6">
              <label>–£—Ä–æ–Ω/–≤–∏–¥</label>
              <input type="text" id="newAtkDmg" placeholder="1–∫6+3 –∫–æ–ª—é—â–∏–π" />
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <button class="btn" id="addAttack">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
          </div>

          <div class="table" id="atkTable">
            ${rows || `<div class="mini"> </div>`}
          </div>
        </div>
      </div>
    `;
  }

  function statBlock(r, title, statKey, skills){
    const score = Number(r.stats?.[statKey] ?? 10);
    const mod = statMod(score);
    const modTxt = (mod>=0?`+${mod}`:`${mod}`);

    const skillsHtml = skills.length ? skills.map(s=>{
      const on = !!(r.prof?.[s.k]);
      const skVal = mod + (on?3:0);
      const skTxt = (skVal>=0?`+${skVal}`:`${skVal}`);
      return `
        <div class="skillRow" data-skill="${s.k}" data-stat="${statKey}">
          <div class="dotToggle ${on?"on":""}"></div>
          <div class="name">${esc(s.name)}</div>
          <div class="val">${esc(skTxt)}</div>
        </div>
      `;
    }).join("") : ``;

    return `
      <div class="statLSS" data-stat="${statKey}">
        <div class="h">
          <b>${esc(title)}</b>
          <div class="right">
            <div class="pillbtn stat-roll">${esc(modTxt)}</div>
            <input class="scoreInput stat-score" type="number" min="1" max="30" value="${score}" />
          </div>
        </div>
        <div class="b">${skillsHtml}</div>
      </div>
    `;
  }

  function abilitiesPage(r){
    return `
      ${profilePanel(r)}

      <div class="abilities-wrap">
        <div class="cards" id="statsCol">
          ${statBlock(r, "–°–ò–õ–ê", "str", [{k:"athletics", name:"–ê—Ç–ª–µ—Ç–∏–∫–∞"}])}
          ${statBlock(r, "–õ–û–í–ö–û–°–¢–¨", "dex", [
            {k:"acrobatics", name:"–ê–∫—Ä–æ–±–∞—Ç–∏–∫–∞"},
            {k:"sleight", name:"–õ–æ–≤–∫–æ—Å—Ç—å —Ä—É–∫"},
            {k:"stealth", name:"–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å"},
          ])}
          ${statBlock(r, "–¢–ï–õ–û–°–õ–û–ñ–ï–ù–ò–ï", "con", [])}
          ${statBlock(r, "–ò–ù–¢–ï–õ–õ–ï–ö–¢", "int", [
            {k:"arcana", name:"–ú–∞–≥–∏—è"},
            {k:"history", name:"–ò—Å—Ç–æ—Ä–∏—è"},
            {k:"investigation", name:"–ê–Ω–∞–ª–∏–∑"},
            {k:"nature", name:"–ü—Ä–∏—Ä–æ–¥–∞"},
            {k:"religion", name:"–†–µ–ª–∏–≥–∏—è"},
          ])}
          ${statBlock(r, "–ú–£–î–†–û–°–¢–¨", "wis", [
            {k:"animal", name:"–£—Ö–æ–¥ –∑–∞ –∂–∏–≤–æ—Ç–Ω—ã–º–∏"},
            {k:"insight", name:"–ü—Ä–æ–Ω–∏—Ü–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å"},
            {k:"medicine", name:"–ú–µ–¥–∏—Ü–∏–Ω–∞"},
            {k:"perception", name:"–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ"},
            {k:"survival", name:"–í—ã–∂–∏–≤–∞–Ω–∏–µ"},
          ])}
          ${statBlock(r, "–•–ê–†–ò–ó–ú–ê", "cha", [
            {k:"deception", name:"–û–±–º–∞–Ω"},
            {k:"intimidation", name:"–ó–∞–ø—É–≥–∏–≤–∞–Ω–∏–µ"},
            {k:"performance", name:"–í—ã—Å—Ç—É–ø–ª–µ–Ω–∏–µ"},
            {k:"persuasion", name:"–£–±–µ–∂–¥–µ–Ω–∏–µ"},
          ])}
        </div>

        <div class="cards">
          <div class="panel">
            <div class="panel-h"><b>–°–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏</b></div>
            <div class="panel-b">
              <label>–¢–µ–∫—Å—Ç</label>
              <textarea id="abilitiesText" placeholder="–ü–∏—à–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –≤–æ—Ä–æ–Ω–∞ –∑–¥–µ—Å—å...">${esc(r.abilitiesText||"")}</textarea>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  function notesPage(r){
    return `
      ${profilePanel(r)}
      <div class="panel">
        <div class="panel-h"><b>–ó–∞–º–µ—Ç–∫–∏</b></div>
        <div class="panel-b">
          <label>–¢–µ–∫—Å—Ç</label>
          <textarea id="notesText" placeholder="–ù–∞–±—Ä–æ—Å–∫–∏, –ø–ª–∞–Ω—ã, —á—Ç–æ –≤–∏–¥–µ–ª...">${esc(r.notesText||"")}</textarea>
        </div>
      </div>
    `;
  }

  function spellsPage(r){
    const settingsRows = Array.from({length:9}).map((_,i)=>{
      const lvl = i+1;
      const v = (r.slots?.[lvl]?.max ?? null);
      const show = (v===null || v===undefined) ? "" : String(v);
      return `
        <div class="field">
          <label>${lvl} —É—Ä. (–º–∞–∫—Å)</label>
          <input type="number" min="0" max="20" data-slotmax="${lvl}" placeholder="‚Äî" value="${show}" />
        </div>
      `;
    }).join("");

    const lvlBlocks = [];
    for(let lvl=0; lvl<=9; lvl++){
      const spells = (r.spells||[]).filter(s => Number(s.level)===lvl);
      const slot = r.slots?.[lvl] || {max:null, used:0};
      const max = (slot.max===null || slot.max===undefined) ? 0 : clamp(Number(slot.max),0,20);
      const used = clamp(Number(slot.used||0),0,max);

      const circles = (lvl===0)
        ? `<div class="mini"> </div>`
        : (max>0 ? `
            <div class="slots" data-lvl="${lvl}">
              ${Array.from({length:max}).map((_,idx)=>{
                const isUsed = idx < used;
                return `<div class="slot ${isUsed?"used":""}" data-i="${idx}"></div>`;
              }).join("")}
            </div>
          ` : `<div class="mini"> </div>`);

      const list = spells.length
        ? spells.map(sp => `
            <div class="spell-row" data-sid="${sp.id}">
              <div>
                <div class="name">${esc(sp.name||"‚Äî")}</div>
                <div class="mini">${esc(sp.notes||"")}</div>
              </div>
              <input type="text" class="sp-notes" placeholder="–ó–∞–º–µ—Ç–∫–∞" value="${escAttr(sp.notes||"")}" />
              <div class="iconbtn danger" data-act="sdel">‚àí</div>
            </div>
          `).join("")
        : `<div class="mini"> </div>`;

      lvlBlocks.push(`
        <div class="lvl" data-level="${lvl}">
          <div class="lvl-h">
            <b>${lvl===0 ? "–ó–∞–≥–æ–≤–æ—Ä—ã" : `${lvl} —É—Ä–æ–≤–µ–Ω—å`}</b>
            ${circles}
          </div>
          <div class="lvl-b">${list}</div>
        </div>
      `);
    }

    return `
      ${profilePanel(r)}

      <div class="panel">
        <div class="panel-h">
          <b>–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</b>
          <div class="sp-gear">
            <button class="btn" id="addSpell">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            <div class="gearbtn" id="spGear">‚öô</div>
          </div>
        </div>
        <div class="panel-b">
          <div class="sp-settings ${spSettingsOpen ? "open" : ""}" id="spSettings">
            <div class="grid">${settingsRows}</div>
          </div>

          <div class="grid" style="margin: 10px 0 14px;">
            <div class="field w6">
              <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
              <input type="text" id="newSpName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Bless" />
            </div>
            <div class="field">
              <label>–£—Ä–æ–≤–µ–Ω—å</label>
              <input type="number" min="0" max="9" id="newSpLvl" value="1" />
            </div>
            <div class="field w6">
              <label>–ó–∞–º–µ—Ç–∫–∞</label>
              <input type="text" id="newSpNotes" placeholder="–∫–æ–Ω—Ü., 60 —Ñ—Ç, 1 –º–∏–Ω..." />
            </div>
          </div>

          ${lvlBlocks.join("")}
        </div>
      </div>
    `;
  }

  function renderPage(){
    const r = getSel();
    if(!r){ elPage.innerHTML=""; return; }

    if(activeTab==="attacks"){
      elPage.innerHTML = attacksPage(r);
      bindCommonProfile(r);
      bindAttacks(r);
      return;
    }
    if(activeTab==="abilities"){
      elPage.innerHTML = abilitiesPage(r);
      bindCommonProfile(r);
      bindAbilities(r);
      return;
    }
    if(activeTab==="notes"){
      elPage.innerHTML = notesPage(r);
      bindCommonProfile(r);
      bindNotes(r);
      return;
    }
    if(activeTab==="spells"){
      elPage.innerHTML = spellsPage(r);
      bindCommonProfile(r);
      bindSpells(r);
      return;
    }
  }

  function renderAll(){
    renderList();
    renderTop();
    renderTabs();
    renderHud();
    renderPage();
  }

  // ==========================
  // 7) BIND
  // ==========================
  function bindCommonProfile(r){
    elPage.querySelectorAll("[data-k]").forEach(inp=>{
      inp.addEventListener("input", ()=>{
        const k = inp.dataset.k;
        let v = inp.value;
        if(inp.type==="number") v = Number(v);
        r[k] = v;
        updated();
        renderList();
        renderTop();
      });
    });
  }

  function bindAttacks(r){
    const addBtn = elPage.querySelector("#addAttack");
    const nName = elPage.querySelector("#newAtkName");
    const nBonus = elPage.querySelector("#newAtkBonus");
    const nDmg = elPage.querySelector("#newAtkDmg");
    const table = elPage.querySelector("#atkTable");

    addBtn.addEventListener("click", ()=>{
      const name = (nName.value||"").trim();
      const bonus = (nBonus.value||"").trim();
      const damage = (nDmg.value||"").trim();
      if(!name) return;
      r.attacks = r.attacks || [];
      r.attacks.push({ id: rid(), name, bonus: bonus||"0", damage });
      nName.value=""; nBonus.value=""; nDmg.value="";
      updated();
      renderPage();
      showToast("–ê—Ç–∞–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");
    });

    table.addEventListener("click", (e)=>{
      if(e.target?.dataset?.act === "del"){
        const row = e.target.closest("[data-id]");
        const id = row?.dataset?.id;
        if(!id) return;
        r.attacks = (r.attacks||[]).filter(a => a.id !== id);
        updated();
        renderPage();
        showToast("–£–¥–∞–ª–µ–Ω–æ");
        return;
      }

      const row = e.target.closest("[data-id]");
      if(!row) return;
      const id = row.dataset.id;
      const a = (r.attacks||[]).find(x=>x.id===id);
      if(!a) return;

      if(e.target.classList.contains("atk-bonus")){
        const bonus = parseBonusNumber(a.bonus);
        const res = rollD20Plus(bonus);
        showRoll(`–ë—Ä–æ—Å–æ–∫ –∞—Ç–∞–∫–∏`, res.total, res.detail, `${a.name}`);
        return;
      }

      if(e.target.classList.contains("atk-dmgchip")){
        const parsed = parseDiceExpression(a.damage);
        const roll = rollFromParsed(parsed);
        const detail = parsed.constant !== null ? `${roll.detail}` : `${parsedToShort(parsed)} ‚Ä¢ ${roll.detail}`;
        showRoll(`–£—Ä–æ–Ω`, roll.total, detail, `${a.name}`);
        return;
      }
    });

    table.querySelectorAll(".atk-name").forEach(nameEl=>{
      nameEl.addEventListener("dblclick", (e)=>{
        const row = e.target.closest("[data-id]");
        const id = row?.dataset?.id;
        if(!id) return;
        openAtkEditor(id);
      });
    });
  }

  function bindAbilities(r){
    elPage.querySelectorAll(".statLSS").forEach(block=>{
      const statKey = block.dataset.stat;
      const input = block.querySelector(".stat-score");
      const rollBtn = block.querySelector(".stat-roll");

      function refresh(){
        const v = clamp(Number(input.value),1,30);
        input.value = v;
        r.stats[statKey] = v;

        const m = statMod(v);
        rollBtn.textContent = (m>=0?`+${m}`:`${m}`);

        block.querySelectorAll(".skillRow").forEach(sr=>{
          const sk = sr.dataset.skill;
          const on = !!(r.prof?.[sk]);
          const v2 = m + (on?3:0);
          const txt = (v2>=0?`+${v2}`:`${v2}`);
          sr.querySelector(".val").textContent = txt;
          sr.querySelector(".dotToggle").classList.toggle("on", on);
        });
      }

      input.addEventListener("input", ()=>{ refresh(); updated(); });

      rollBtn.addEventListener("click", ()=>{
        const m = statMod(Number(input.value)||10);
        const res = rollD20Plus(m);
        showRoll(`–ü—Ä–æ–≤–µ—Ä–∫–∞`, res.total, res.detail, statName(statKey));
      });

      block.querySelectorAll(".skillRow").forEach(sr=>{
        const sk = sr.dataset.skill;
        const dot = sr.querySelector(".dotToggle");
        const val = sr.querySelector(".val");

        dot.addEventListener("click", ()=>{
          r.prof[sk] = !r.prof[sk];
          refresh();
          updated();
        });

        val.addEventListener("click", ()=>{
          const m = statMod(Number(input.value)||10);
          const on = !!(r.prof?.[sk]);
          const totalBonus = m + (on?3:0);
          const res = rollD20Plus(totalBonus);
          showRoll(`–ù–∞–≤—ã–∫`, res.total, res.detail, sr.querySelector(".name").textContent);
        });
      });

      refresh();
    });

    const ta = elPage.querySelector("#abilitiesText");
    ta.addEventListener("input", ()=>{
      r.abilitiesText = ta.value;
      updated();
    });
  }

  function bindNotes(r){
    const ta = elPage.querySelector("#notesText");
    ta.addEventListener("input", ()=>{
      r.notesText = ta.value;
      updated();
    });
  }

  function bindSpells(r){
    const spGear = elPage.querySelector("#spGear");
    const spSettings = elPage.querySelector("#spSettings");

    spGear.addEventListener("click", ()=>{
      spSettingsOpen = !spSettingsOpen;
      spSettings.classList.toggle("open", spSettingsOpen);
    });

    elPage.querySelectorAll("[data-slotmax]").forEach(inp=>{
      const lvl = Number(inp.dataset.slotmax);

      const apply = ()=>{
        ensureSlots(r,lvl);
        const raw = inp.value.trim();
        if(raw === ""){
          r.slots[lvl].max = null;
          r.slots[lvl].used = 0;
        } else {
          const max = clamp(Number(raw),0,20);
          r.slots[lvl].max = max;
          r.slots[lvl].used = clamp(r.slots[lvl].used,0,max);
        }
        updated();
        renderPage();
      };

      inp.addEventListener("change", apply);
      inp.addEventListener("blur", apply);
      inp.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); inp.blur(); }});
    });

    elPage.querySelectorAll(".slots[data-lvl]").forEach(wrap=>{
      wrap.addEventListener("click", (e)=>{
        const dot = e.target?.classList?.contains("slot") ? e.target : null;
        if(!dot) return;
        const lvl = Number(wrap.dataset.lvl);
        const idx = Number(dot.dataset.i);

        ensureSlots(r,lvl);
        const max = (r.slots[lvl].max==null) ? 0 : clamp(Number(r.slots[lvl].max),0,20);
        let used = clamp(Number(r.slots[lvl].used||0),0,max);

        if(idx < used) used = idx;
        else used = idx + 1;

        r.slots[lvl].used = clamp(used,0,max);
        updated();
        renderPage();
      });
    });

    const addSpell = elPage.querySelector("#addSpell");
    const nName = elPage.querySelector("#newSpName");
    const nLvl = elPage.querySelector("#newSpLvl");
    const nNotes = elPage.querySelector("#newSpNotes");

    addSpell.addEventListener("click", ()=>{
      const name = (nName.value||"").trim();
      const level = clamp(Number(nLvl.value),0,9);
      const notes = (nNotes.value||"").trim();
      if(!name) return;
      r.spells.push({ id: rid(), name, level, notes });
      nName.value=""; nNotes.value="";
      updated();
      renderPage();
      showToast("–î–æ–±–∞–≤–ª–µ–Ω–æ");
    });

    elPage.querySelectorAll(".spell-row").forEach(row=>{
      const id = row.dataset.sid;
      const del = row.querySelector("[data-act='sdel']");
      const inp = row.querySelector(".sp-notes");

      del.addEventListener("click", ()=>{
        r.spells = r.spells.filter(s => s.id !== id);
        updated();
        renderPage();
        showToast("–£–¥–∞–ª–µ–Ω–æ");
      });

      inp.addEventListener("input", ()=>{
        const s = r.spells.find(x=>x.id===id);
        if(!s) return;
        s.notes = inp.value;
        updated();
      });
    });
  }

  // ==========================
  // 8) HP MODAL (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ "2 -> 22")
  // ==========================
  function openHp(){
    const r = getSel(); if(!r) return;
    hpDraftInput = "0";
    hpSettings.classList.remove("open");
    setHpMax.value = String(r.hp.max ?? 0);
    setHpBonus.value = String(r.hp.bonusMax ?? 0);
    hpBack.style.display = "flex";
    updateHpUI();
  }
  function closeHp(){ hpBack.style.display = "none"; renderHud(); }

  function updateHpUI(){
    const r = getSel(); if(!r) return;
    hpBig.textContent = `${r.hp.current}/${trueMax(r)}`;
    hpTemp.textContent = (r.hp.temp>0) ? `+${r.hp.temp}` : `+0`;
    hpInput.textContent = hpDraftInput;
  }

  // –ì–ª–∞–≤–Ω–æ–µ: –µ—Å–ª–∏ –≤–≤–æ–¥ "0" -> –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ —Ü–∏—Ñ—Ä—É, –∞ –Ω–µ –ø—Ä–∏–ø–∏—Å—ã–≤–∞–µ–º
  function addToHpInput(d){
    if(!d) return;

    // –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ —Å–æ–±—ã—Ç–∏—é: –∏–≥–Ω–æ—Ä –µ—Å–ª–∏ –ø—Ä–∏—à–ª–æ –Ω–µ –∏–∑ –∫–Ω–æ–ø–∫–∏
    // (–Ω–∞ —Å–ª—É—á–∞–π —Ç–∞—á-–ø–æ–≤–µ–¥–µ–Ω–∏—è). –≠—Ç–æ –º—è–≥–∫–∞—è –∑–∞—â–∏—Ç–∞.
    if(typeof d !== "string") d = String(d);

    if(hpDraftInput === "0"){
      hpDraftInput = d;
    } else {
      hpDraftInput += d;
    }

    // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã
    if(hpDraftInput.length > 6) hpDraftInput = hpDraftInput.slice(0,6);
  }

  function backspaceHp(){
    hpDraftInput = hpDraftInput.length>1 ? hpDraftInput.slice(0,-1) : "0";
    updateHpUI();
  }

  function applyHp(mode){
    const r = getSel(); if(!r) return;
    const n = clamp(Number(hpDraftInput||"0"),0,9999);
    if(n===0) return;

    const max = trueMax(r);

    if(mode==="temp"){
      r.hp.temp = clamp(n,0,999);
      hpDraftInput = "0";
      updated();
      updateHpUI();
      renderHud();
      return;
    }
    if(mode==="heal"){
      r.hp.current = clamp(r.hp.current + n, 0, max);
      hpDraftInput = "0";
      updated();
      updateHpUI();
      renderHud();
      return;
    }

    // damage
    let dmg = n;
    if(r.hp.temp > 0){
      const take = Math.min(r.hp.temp, dmg);
      r.hp.temp -= take;
      dmg -= take;
    }
    if(dmg>0) r.hp.current = clamp(r.hp.current - dmg, 0, max);

    hpDraftInput = "0";
    updated();
    updateHpUI();
    renderHud();
  }

  // ==========================
  // 9) –ö–ó / –°–ö–û–†–û–°–¢–¨ / –ê–¢–ê–ö–ò EDIT
  // ==========================
  function openKz(){
    const r = getSel(); if(!r) return;
    kzInput.value = String(r.kz ?? 10);
    kzBack.style.display = "flex";
    kzInput.focus();
    kzInput.select();
  }
  function closeKz(){ kzBack.style.display = "none"; }
  function saveKz(){
    const r = getSel(); if(!r) return;
    r.kz = clamp(Number(kzInput.value),0,99);
    updated();
    renderHud();
    closeKz();
  }

  function openSpeed(){
    const r = getSel(); if(!r) return;
    spdInput.value = String(r.speed ?? 0);
    flyInput.value = String(r.fly ?? 0);
    spdBack.style.display = "flex";
    spdInput.focus();
    spdInput.select();
  }
  function closeSpeed(){ spdBack.style.display = "none"; }
  function saveSpeed(){
    const r = getSel(); if(!r) return;
    r.speed = clamp(Number(spdInput.value),0,999);
    r.fly = clamp(Number(flyInput.value),0,999);
    updated();
    renderHud();
    closeSpeed();
  }

  function openAtkEditor(id){
    const r = getSel(); if(!r) return;
    const a = r.attacks.find(x=>x.id===id);
    if(!a) return;
    atkEditingId = id;
    atkEditName.value = a.name || "";
    atkEditBonus.value = a.bonus || "";
    atkEditDamage.value = a.damage || "";
    atkBack.style.display = "flex";
    atkEditName.focus();
    atkEditName.select();
  }
  function closeAtkEditor(){
    atkBack.style.display = "none";
    atkEditingId = null;
  }
  function saveAtkEditor(){
    const r = getSel(); if(!r || !atkEditingId) return;
    const a = r.attacks.find(x=>x.id===atkEditingId);
    if(!a) return;
    a.name = (atkEditName.value||"").trim() || a.name;
    a.bonus = (atkEditBonus.value||"").trim() || "0";
    a.damage = (atkEditDamage.value||"").trim() || "";
    updated();
    renderPage();
    closeAtkEditor();
  }

  // ==========================
  // 10) ROLL POPUP + DISCORD
  // ==========================
  let rollTimer = null;
  function showRoll(title, total, detail, extra){
    rollTitle.textContent = title || "–ë–†–û–°–û–ö";
    rollBig.textContent = String(total);
    rollSub.textContent = detail || "";
    rollExtra.textContent = extra ? extra : "";
    rollPop.style.display = "block";

    const r = getSel();
    sendRollToDiscord({
      title, total, detail, extra,
      ravenName: r?.name,
      ravenImg: r?.img
    });

    if(rollTimer) clearTimeout(rollTimer);
    rollTimer = setTimeout(()=>{ rollPop.style.display="none"; }, 3500);
  }
  function hideRoll(){ rollPop.style.display = "none"; }

  // ==========================
  // 11) SAVE (LOCAL + CLOUD)
  // ==========================
  let saveTimer = null;
  function persistLocal(){
    localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(state));
  }

  function updated(){
    state.meta.updatedAt = Date.now();
    elSaveState.textContent = "saving‚Ä¶";

    if(saveTimer) clearTimeout(saveTimer);
    saveTimer = setTimeout(()=>{
      persistLocal();
      elSaveState.textContent = "autosave";
      showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");

      // Cloud debounce
      if(cloudSaveTimer) clearTimeout(cloudSaveTimer);
      cloudSaveTimer = setTimeout(()=> cloudSave(false), 650);

    }, 220);
  }

  // toast
  let toastTimer = null;
  function showToast(t){
    toastText.textContent = t || "–ì–æ—Ç–æ–≤–æ";
    toast.style.display = "flex";
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> toast.style.display="none", 900);
  }

  // ==========================
  // 12) ROOM MODAL HELPERS
  // ==========================
  function openRoom(){
    roomKeyInput.value = roomKey || "";
    inviteLink.value = buildInviteLink(roomKeyInput.value.trim());
    roomBack.style.display = "flex";
    setTimeout(()=> roomKeyInput.focus(), 50);
  }
  function closeRoom(){ roomBack.style.display = "none"; }

  function buildInviteLink(k){
    const key = (k||"").trim();
    const u = new URL(location.href);
    if(key) u.searchParams.set("room", key);
    else u.searchParams.delete("room");
    return u.toString();
  }

  roomKeyInput.addEventListener("input", ()=>{
    inviteLink.value = buildInviteLink(roomKeyInput.value);
  });

  copyInvite.addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(inviteLink.value);
      showToast("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞");
    }catch{
      showToast("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å");
    }
  });

  roomOk.addEventListener("click", async ()=>{
    const k = (roomKeyInput.value||"").trim();
    if(!k) return;
    roomKey = k;
    localStorage.setItem(ROOM_KEY_STORAGE, roomKey);
    setRoomInURL(roomKey);
    closeRoom();
    serverReady = false;
    await cloudLoad();
  });

  roomClose.addEventListener("click", closeRoom);
  roomBack.addEventListener("click", (e)=>{ if(e.target===roomBack) closeRoom(); });
  roomBtn.addEventListener("click", openRoom);

  // ==========================
  // 13) EVENTS
  // ==========================
  function moveSelect(dir){
    const list = state.ravens;
    const idx = list.findIndex(r=>r.id===selectedId);
    const next = (idx + dir + list.length) % list.length;
    selectedId = list[next].id;
    renderAll();
  }

  btnPrev.addEventListener("click", () => moveSelect(-1));
  btnNext.addEventListener("click", () => moveSelect(1));

  elTabs.addEventListener("click", (e) => {
    const t = e.target?.dataset?.tab;
    if(!t) return;
    activeTab = t;
    renderTabs();
    renderPage();
  });

  hpTile.addEventListener("click", () => openHp());
  kzTile.addEventListener("click", openKz);
  speedTile.addEventListener("click", openSpeed);

  rollClose.addEventListener("click", () => hideRoll());

  window.addEventListener("keydown", (e) => {
    if(e.ctrlKey && e.key.toLowerCase()==="s"){
      e.preventDefault();
      persistLocal();
      cloudSave(false);
      showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
    }
    if(e.key==="Escape"){
      if(hpBack.style.display==="flex") closeHp();
      if(kzBack.style.display==="flex") closeKz();
      if(spdBack.style.display==="flex") closeSpeed();
      if(atkBack.style.display==="flex") closeAtkEditor();
      if(roomBack.style.display==="flex") closeRoom();
      if(rollPop.style.display==="block") hideRoll();
    }

    if(hpBack.style.display==="flex"){
      if(e.key>="0" && e.key<="9"){ addToHpInput(e.key); updateHpUI(); }
      else if(e.key==="Backspace"){ backspaceHp(); }
    }

    if(kzBack.style.display==="flex" && e.key==="Enter") saveKz();
    if(spdBack.style.display==="flex" && e.key==="Enter") saveSpeed();
  });

  keypad.addEventListener("click", (e) => {
    const k = e.target?.dataset?.k;
    if(!k) return;
    if(k==="clr") hpDraftInput = "0";
    else if(k==="00") addToHpInput("00");
    else addToHpInput(k);
    updateHpUI();
  });

  hpBackspace.addEventListener("click", backspaceHp);
  hpGear.addEventListener("click", ()=> hpSettings.classList.toggle("open"));
  actClear.addEventListener("click", ()=>{ hpDraftInput="0"; updateHpUI(); });

  actTemp.addEventListener("click", ()=> applyHp("temp"));
  actHeal.addEventListener("click", ()=> applyHp("heal"));
  actDmg.addEventListener("click", ()=> applyHp("damage"));

  hpClose.addEventListener("click", closeHp);
  hpDone.addEventListener("click", closeHp);
  hpBack.addEventListener("click", (e)=>{ if(e.target===hpBack) closeHp(); });

  setHpMax.addEventListener("input", ()=>{
    const r = getSel(); if(!r) return;
    r.hp.max = clamp(Number(setHpMax.value),0,999);
    r.hp.current = clamp(r.hp.current,0,trueMax(r));
    updated();
    updateHpUI();
    renderHud();
  });
  setHpBonus.addEventListener("input", ()=>{
    const r = getSel(); if(!r) return;
    r.hp.bonusMax = clamp(Number(setHpBonus.value),-99,999);
    r.hp.current = clamp(r.hp.current,0,trueMax(r));
    updated();
    updateHpUI();
    renderHud();
  });

  kzClose.addEventListener("click", closeKz);
  kzOk.addEventListener("click", saveKz);
  kzBack.addEventListener("click", (e)=>{ if(e.target===kzBack) closeKz(); });

  spdClose.addEventListener("click", closeSpeed);
  spdOk.addEventListener("click", saveSpeed);
  spdBack.addEventListener("click", (e)=>{ if(e.target===spdBack) closeSpeed(); });

  atkClose.addEventListener("click", closeAtkEditor);
  atkBack.addEventListener("click", (e)=>{ if(e.target===atkBack) closeAtkEditor(); });
  atkSave.addEventListener("click", saveAtkEditor);

  // ==========================
  // 14) INIT
  // ==========================
  renderAll();

  (async ()=>{
    // 1) –µ—Å–ª–∏ room –µ—Å—Ç—å –≤ URL ‚Äî –±–µ—Ä—ë–º –µ–≥–æ
    const urlRoom = getRoomFromURL();
    if(urlRoom){
      roomKey = urlRoom;
      localStorage.setItem(ROOM_KEY_STORAGE, roomKey);
      setRoomInURL(roomKey);
    }

    // 2) –µ—Å–ª–∏ –∫–ª—é—á–∞ –Ω–µ—Ç ‚Äî –æ—Ç–∫—Ä–æ–µ–º –æ–∫–Ω–æ
    if(!roomKey){
      openRoom();
      return;
    }

    // 3) –ø—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ–±–ª–∞–∫–æ
    await cloudLoad();
  })();

})();
</script>
</body>
</html>
